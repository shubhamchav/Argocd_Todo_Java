
name: Build, GPG Sign, Upload to S3, Deploy to EC2

permissions:
  id-token: write
  contents: read

on:
  push:
    branches:
      - master

jobs:
  build-sign-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build JAR
        run: mvn clean package -DskipTests
        shell: bash

      - name: Import GPG key
        run: |
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        shell: bash

      - name: GPG sign JAR
        run: |
          JAR_FILE=$(ls target/*.jar | head -n 1)
          gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --armor --detach-sign "$JAR_FILE"
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        shell: bash

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Upload JAR and signature to S3
        run: |
          JAR_FILE=$(ls target/*.jar | head -n 1)
          aws s3 cp "$JAR_FILE" s3://shubhamgpgpoc/
          aws s3 cp "$JAR_FILE.asc" s3://shubhamgpgpoc/
        shell: bash

  deploy-ec2:
    needs: build-sign-upload
    runs-on: ubuntu-latest
    steps:
      - name: Download SSH key
        run: |
          echo "$EC2_SSH_KEY" > ec2_key.pem
          chmod 600 ec2_key.pem
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        shell: bash

      - name: Deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            set -e
            sudo apt-get update && sudo apt-get install -y awscli gnupg openjdk-17-jre-headless
            cd ~
            aws s3 cp s3://shubhamgpgpoc/ . --recursive --exclude "*" --include "*.jar" --include "*.jar.asc"
            JAR_FILE=$(ls *.jar | head -n 1)
            echo "Verifying GPG signature..."
            gpg --batch --verify "$JAR_FILE.asc" "$JAR_FILE"
            if pgrep -f "$JAR_FILE"; then pkill -f "$JAR_FILE"; fi
            echo "Starting application..."
            nohup java -jar "$JAR_FILE" > app.log 2>&1 &
          '
        shell: bash
